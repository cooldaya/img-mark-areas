import{S as O,r as v,a as A,w as L,o as C,c as M,b as p,d as y,e as D,f as E,p as J,g as B,h as T,i as j,j as F,k as U,l as I}from"./index-Bx8CzKcP.js";import{_ as R,P as $}from"./PageToggle-C5Yo8GLn.js";const e={img_url:null,img_el:null,img_md5:null,canvas_el:null,ctx:null,design:{dw:1920,dh:1080},writing:!1,fontSize:16,currentPoints:[],shapes:[],markPinterColor:"black"};class V{md5(o,i,a){this.aborted=!1,this.progress=0;let l=0;const d=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,r=2097152,m=Math.ceil(o.size/r),h=new O.ArrayBuffer,S=new FileReader;_(),S.onloadend=f=>{if(h.append(f.target.result),l++,this.progress=l/m,a&&typeof a=="function"&&a(this.progress),this.aborted){i("aborted");return}l<m?_():i(null,h.end())};function _(){const f=l*r,n=f+r>=o.size?o.size:f+r;S.readAsArrayBuffer(d.call(o,f,n))}}abort(){this.aborted=!0}}const G="data:image/svg+xml,%3c?xml%20version='1.0'%20standalone='no'?%3e%3c!DOCTYPE%20svg%20PUBLIC%20'-//W3C//DTD%20SVG%201.1//EN'%20'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3e%3csvg%20t='1717095018882'%20class='icon'%20viewBox='0%200%201024%201024'%20version='1.1'%20xmlns='http://www.w3.org/2000/svg'%20p-id='1022'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20width='200'%20height='200'%3e%3cpath%20d='M876.864%20782.592c3.264%200%206.272-3.2%206.272-6.656%200-3.456-3.008-6.592-6.272-6.592-3.264%200-6.272%203.2-6.272%206.592%200%203.456%203.008%206.656%206.272%206.656z%20m-140.544%20153.344c2.304%202.432%205.568%203.84%208.768%203.84a12.16%2012.16%200%200%200%208.832-3.84%2013.76%2013.76%200%200%200%200-18.56%2012.224%2012.224%200%200%200-8.832-3.84%2012.16%2012.16%200%200%200-8.768%203.84%2013.696%2013.696%200%200%200%200%2018.56zM552.32%201018.24c3.456%203.648%208.32%205.76%2013.184%205.76a18.368%2018.368%200%200%200%2013.184-5.76%2020.608%2020.608%200%200%200%200-27.968%2018.368%2018.368%200%200%200-13.184-5.824%2018.368%2018.368%200%200%200-13.184%205.76%2020.608%2020.608%200%200%200%200%2028.032z%20m-198.336-5.76c4.608%204.8%2011.072%207.68%2017.6%207.68a24.448%2024.448%200%200%200%2017.536-7.68%2027.456%2027.456%200%200%200%200-37.248%2024.448%2024.448%200%200%200-17.536-7.68%2024.448%2024.448%200%200%200-17.6%207.68%2027.52%2027.52%200%200%200%200%2037.184z%20m-175.68-91.84c5.76%206.08%2013.824%209.6%2021.952%209.6a30.592%2030.592%200%200%200%2022.016-9.6%2034.368%2034.368%200%200%200%200-46.592%2030.592%2030.592%200%200%200-22.016-9.6%2030.592%2030.592%200%200%200-21.952%209.6%2034.368%2034.368%200%200%200%200%2046.592z%20m-121.152-159.36c6.912%207.36%2016.64%2011.648%2026.368%2011.648a36.736%2036.736%200%200%200%2026.432-11.584%2041.28%2041.28%200%200%200%200-55.936%2036.736%2036.736%200%200%200-26.432-11.584%2036.8%2036.8%200%200%200-26.368%2011.52%2041.28%2041.28%200%200%200%200%2056zM12.736%20564.672a42.88%2042.88%200%200%200%2030.784%2013.44%2042.88%2042.88%200%200%200%2030.784-13.44%2048.128%2048.128%200%200%200%200-65.216%2042.88%2042.88%200%200%200-30.72-13.44%2042.88%2042.88%200%200%200-30.848%2013.44%2048.128%2048.128%200%200%200%200%2065.216z%20m39.808-195.392a48.96%2048.96%200%200%200%2035.2%2015.36%2048.96%2048.96%200%200%200%2035.2-15.36%2054.976%2054.976%200%200%200%200-74.56%2048.96%2048.96%200%200%200-35.2-15.424%2048.96%2048.96%200%200%200-35.2%2015.424%2054.976%2054.976%200%200%200%200%2074.56zM168.32%20212.48c10.368%2011.008%2024.96%2017.408%2039.68%2017.408%2014.592%200%2029.184-6.4%2039.552-17.408a61.888%2061.888%200%200%200%200-83.84%2055.104%2055.104%200%200%200-39.616-17.408c-14.656%200-29.248%206.4-39.616%2017.408a61.888%2061.888%200%200%200%200%2083.84zM337.344%20124.8c11.52%2012.16%2027.712%2019.264%2043.968%2019.264%2016.256%200%2032.448-7.04%2043.968-19.264a68.672%2068.672%200%200%200%200-93.184%2061.248%2061.248%200%200%200-43.968-19.264%2061.248%2061.248%200%200%200-43.968%2019.264%2068.736%2068.736%200%200%200%200%2093.184z%20m189.632-1.088c12.672%2013.44%2030.528%2021.248%2048.448%2021.248s35.712-7.808%2048.384-21.248a75.584%2075.584%200%200%200%200-102.464A67.392%2067.392%200%200%200%20575.36%200c-17.92%200-35.776%207.808-48.448%2021.248a75.584%2075.584%200%200%200%200%20102.464z%20m173.824%2086.592c13.824%2014.592%2033.28%2023.104%2052.736%2023.104%2019.584%200%2039.04-8.512%2052.8-23.104a82.432%2082.432%200%200%200%200-111.744%2073.472%2073.472%200%200%200-52.8-23.168c-19.52%200-38.912%208.512-52.736%2023.168a82.432%2082.432%200%200%200%200%20111.744z%20m124.032%20158.528c14.976%2015.872%2036.032%2025.088%2057.216%2025.088%2021.12%200%2042.24-9.216%2057.152-25.088a89.344%2089.344%200%200%200%200-121.088%2079.616%2079.616%200%200%200-57.152-25.088c-21.184%200-42.24%209.216-57.216%2025.088a89.344%2089.344%200%200%200%200%20121.088z%20m50.432%20204.032c16.128%2017.088%2038.784%2027.008%2061.632%2027.008%2022.784%200%2045.44-9.92%2061.568-27.008a96.256%2096.256%200%200%200%200-130.432%2085.76%2085.76%200%200%200-61.568-27.072c-22.848%200-45.44%209.984-61.632%2027.072a96.192%2096.192%200%200%200%200%20130.432z'%20fill='%23ffffff'%20p-id='1023'%3e%3c/path%3e%3c/svg%3e";function Y(t){return new Promise((o,i)=>{var a=document.createElement("input");a.type="file",Object.assign(a,t),a.onchange=function(l){var d=l.target.files[0];o({file:d})},a.click()})}async function H(t,o="download.json"){if(!(t instanceof Object||t instanceof Array||typeof t=="string"))return console.error("json参数必须是对象或者数组或者字符串");const a=typeof t=="string"?JSON.parse(t):t,l=JSON.stringify(a,null,4),d=window.URL||window.webkitURL||window,r=new Blob([l]),m=document.createElementNS("http://www.w3.org/1999/xhtml","a");m.href=d.createObjectURL(r),m.download=o,m.click()}const W=new V;function X(t){return new Promise((o,i)=>{W.md5(t,(a,l)=>{if(a)return i(a);o({md5:l})})})}function q(){var t=document.createElement("div");t.className="loading-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="rgba(0, 0, 0, 0.3)",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center";var o=document.createElement("div");o.className="loading-icon",o.innerHTML=`<img src="${G}" alt="loading">`,t.appendChild(o),document.body.appendChild(t),i();function i(){var a=document.createElement("style");a.innerHTML=`
      .loading-icon {
        /* 自定义加载样式的样式属性 */
        /* 例如： */
        /* 居中显示 */
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* 添加动画效果 */
        animation: spin 2s linear infinite;
      }
  
      @keyframes spin {
        0% { transform:translate(-50%, -50%) rotate(0deg); }
        100% { transform:translate(-50%, -50%) rotate(360deg); }
      }
    `,document.head.appendChild(a)}return{cancel:function(){document.body.removeChild(t)}}}const x={getShapes(){const t=localStorage.getItem("img-shape-map")||"{}";return JSON.parse(t)[e.img_md5]||[]},getLastId(){const t=localStorage.getItem("img-shape-ids-map")||"{}",i=JSON.parse(t)[e.img_md5]||[];return i.length===0?1:i.sort((l,d)=>l-d).at(-1)*1+1},initShape(){localStorage.getItem("img-shape-map")||(localStorage.setItem("img-shape-map",JSON.stringify({})),localStorage.setItem("img-shape-ids-map",JSON.stringify({})))},saveShape(t){debugger;e.img_md5||alert("请先上传图片");const o=localStorage.getItem("img-shape-map"),i=localStorage.getItem("img-shape-ids-map"),a=JSON.parse(o)||{},l=JSON.parse(i)||{},d=a[e.img_md5]||[],r=l[e.img_md5]||[];let m=!1;if(r.includes(t.id))if(confirm("该点已存在,确认覆盖？"))m=!0;else return;if(m){const h=r.indexOf(t.id+"");debugger;d[h]=t}else d.push(t),r.push(t.id);a[e.img_md5]=d,l[e.img_md5]=r,localStorage.setItem("img-shape-map",JSON.stringify(a)),localStorage.setItem("img-shape-ids-map",JSON.stringify(l))}},K=t=>(J("data-v-b0554deb"),t=t(),B(),t),Q={class:"actions"},Z={class:"settings"},e0=K(()=>p("div",{class:"user-data"},null,-1)),t0={__name:"Controls",setup(t){const o=v(null),i=v(null),a=v(null),l=v(null),d=async()=>{const c=(await Y({accept:"image/*",multiple:!1})).file;e.img_name=c.name;const{md5:g}=await X(c);e.img_md5=g;const u=URL.createObjectURL(c);e.img_url=u,E.emit("update-img-url",{img_url:u}),console.log(e),r()},r=()=>{const s=i.value,c=a.value;s.removeAttribute("disabled"),c.setAttribute("disabled",!0),e.writing=!1,e.currentPoints.length=0,m(),E.emit("reset-control")};function m(){e.ctx.clearRect(0,0,e.canvas_el.width,e.canvas_el.height)}const h=s=>{if(!e.img_url)return alert("请先上传图片");const c=i.value,g=a.value,u=l.value;u.value=x.getLastId(),e.writing=!0,c.setAttribute("disabled",!0),g.removeAttribute("disabled"),alert("开始标记点"),e.currentPoints.length=0,E.emit("start-mark-point")},S=s=>{if(e.currentPoints.length<3)return alert("至少需要三个点才能画图");const c=i.value,g=a.value,u=l.value;e.writing=!1,c.removeAttribute("disabled"),g.setAttribute("disabled",!0),alert("结束标记点");const b={id:u.value,points:[...e.currentPoints]};e.shapes.push(b),x.saveShape(b),_()},_=()=>{if(!e.img_url)return alert("请先上传图片");m();const s=e.shapes=x.getShapes();E.emit("draw-all-shapes",{shapes:s})},f=s=>{e.markPinterColor=s.target.value},n=async()=>{const{cancel:s}=q(),c=x.getShapes(),g=e.img_name.replace(/\.[^/.]+$/,"")+"(区域标记).json";await H(c,g),s()};return(s,c)=>{const g=A("scale-sync");return L((C(),M("div",{class:"controls",ref_key:"controlsElRef",ref:o},[p("div",Q,[p("button",{onClick:y(d,["stop"])},"上传图片"),p("button",{onClick:y(h,["stop"]),ref_key:"startElRef",ref:i},"开始",512),p("button",{onClick:y(S,["stop"]),ref_key:"stopElRef",ref:a,disabled:""},"完毕",512),p("button",{type:"number",onClick:y(_,["stop"])},"画出全部图形"),p("button",{onClick:y(n,["stop"])},"导出数据"),p("button",{onClick:r},"清空画板"),p("input",{type:"number",ref_key:"inputElRef",ref:l},null,512)]),p("div",Z,[p("div",null,[D(" 标记点的颜色 "),p("input",{type:"color",onChange:f},null,32)]),e0])])),[[g]])}}},s0=R(t0,[["__scopeId","data-v-b0554deb"]]),n0={class:"catch-patch"},a0={class:"img-wrap"},o0=["src"],i0={__name:"CatchPatch",props:{},setup(t){const o=v(null),i=v(null),a=v({img_url:""}),l={"update-img-url":n=>{const s=e.img_el;s.onload=c=>{const{width:g,height:u}=s.getBoundingClientRect();m(g,u)},a.value.img_url=n.img_url},"stop-mark-point":n=>{const s=n.shape;f(s)},"draw-all-shapes":n=>{n.shapes.forEach(c=>{f(c)})}};T(l);const d=()=>{const n=o.value,s=n.getContext("2d");s.font=`${e.fontSize}px Arial`,e.canvas_el=n,e.ctx=s,n.width=n.height=0},r=()=>{const n=i.value;e.img_el=n};function m(n,s){e.design.dw=n,e.design.dh=s,e.canvas_el.width=n,e.canvas_el.height=s,e.ctx.clearRect(0,0,n,s)}const h=()=>{x.initShape(),d(),r()},S=n=>{if(e.writing){const s={x:n.offsetX,y:n.offsetY,design:{...e.design},px:(n.offsetX*100/e.design.dw).toFixed(2)+"%",py:(n.offsetY*100/e.design.dh).toFixed(2)+"%"};console.log(s,window.devicePixelRatio),e.currentPoints.push(s),_(s)}else alert("Please start writing first")};function _(n){const s=e.ctx;s.beginPath(),s.arc(n.x,n.y,2,0,2*Math.PI),s.fillStyle=e.markPinterColor,s.fill()}function f(n){const s=e.ctx,{id:c=99,points:g}=n,u=g.length;let b=0,P=0;s.beginPath();for(let k=0;k<u;k++){const w=g[k];if(b+=w.x,P+=w.y,!k){s.moveTo(w.x,w.y);continue}s.lineTo(w.x,w.y)}s.closePath(),s.fillStyle="red",s.fill();const z=b/u,N=P/u;s.fillStyle="white",s.fillText(c,z,N)}return j(()=>{h()}),F(()=>{U(l)}),(n,s)=>(C(),M("div",n0,[I(s0),p("canvas",{ref_key:"canvasElRef",ref:o,onClick:y(S,["stop"])},null,512),p("div",a0,[p("img",{src:a.value.img_url,alt:"",ref_key:"imgElRef",ref:i},null,8,o0)])]))}},l0=R(i0,[["__scopeId","data-v-d72c3f2a"]]),d0={__name:"index",setup(t){return(o,i)=>(C(),M("div",null,[I($),I(l0)]))}};export{d0 as default};
