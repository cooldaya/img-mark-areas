import{r as h,a as A,w as J,o as P,c as C,b as o,d as _,e as D,f as I,p as $,g as B,h as T,i as F,j as L,k as j,l as k}from"./index-C7p-sHzo.js";import{_ as R,g as z,a as U,c as V,d as X,P as Y}from"./PageToggle-B0d0l9e-.js";const t={img_url:null,img_el:null,img_md5:null,canvas_el:null,ctx:null,design:{dw:1920,dh:1080},writing:!1,fontSize:16,currentPoints:[],shapes:[],markPinterColor:"black"},x={getShapes(){const a=localStorage.getItem("img-shape-map")||"{}";return JSON.parse(a)[t.img_md5]||[]},getLastId(){const a=localStorage.getItem("img-shape-ids-map")||"{}",i=JSON.parse(a)[t.img_md5]||[];return i.length===0?1:i.sort((r,m)=>r-m).at(-1)*1+1},initShape(){localStorage.getItem("img-shape-map")||(localStorage.setItem("img-shape-map",JSON.stringify({})),localStorage.setItem("img-shape-ids-map",JSON.stringify({})))},saveShape(a){debugger;t.img_md5||alert("请先上传图片");const g=localStorage.getItem("img-shape-map"),i=localStorage.getItem("img-shape-ids-map"),c=JSON.parse(g)||{},r=JSON.parse(i)||{},m=c[t.img_md5]||[],d=r[t.img_md5]||[];let u=!1;if(d.includes(a.id))if(confirm("该点已存在,确认覆盖？"))u=!0;else return;if(u){const S=d.indexOf(a.id+"");debugger;m[S]=a}else m.push(a),d.push(a.id);c[t.img_md5]=m,r[t.img_md5]=d,localStorage.setItem("img-shape-map",JSON.stringify(c)),localStorage.setItem("img-shape-ids-map",JSON.stringify(r))}},W=a=>($("data-v-706a354f"),a=a(),B(),a),q={class:"actions"},G={class:"settings"},H=W(()=>o("div",{class:"user-data"},null,-1)),K={__name:"Controls",setup(a){const g=h(null),i=h(null),c=h(null),r=h(null),m=async()=>{const n=(await z({accept:"image/*",multiple:!1})).file;t.img_name=n.name;const{md5:l}=await U(n);t.img_md5=l;const p=URL.createObjectURL(n);t.img_url=p,I.emit("update-img-url",{img_url:p}),console.log(t),d()},d=()=>{const e=i.value,n=c.value;e.removeAttribute("disabled"),n.setAttribute("disabled",!0),t.writing=!1,t.currentPoints.length=0,u(),I.emit("reset-control")};function u(){t.ctx.clearRect(0,0,t.canvas_el.width,t.canvas_el.height)}const S=e=>{if(!t.img_url)return alert("请先上传图片");const n=i.value,l=c.value,p=r.value;p.value=x.getLastId(),t.writing=!0,n.setAttribute("disabled",!0),l.removeAttribute("disabled"),alert("开始标记点"),t.currentPoints.length=0,I.emit("start-mark-point")},E=e=>{if(t.currentPoints.length<3)return alert("至少需要三个点才能画图");const n=i.value,l=c.value,p=r.value;t.writing=!1,n.removeAttribute("disabled"),l.setAttribute("disabled",!0),alert("结束标记点");const v={id:p.value,points:[...t.currentPoints]};t.shapes.push(v),x.saveShape(v),y()},y=()=>{if(!t.img_url)return alert("请先上传图片");u();const e=t.shapes=x.getShapes();I.emit("draw-all-shapes",{shapes:e})},b=e=>{t.markPinterColor=e.target.value},s=async()=>{const{cancel:e}=V(),n=x.getShapes(),l=t.img_name.replace(/\.[^/.]+$/,"")+"(区域标记).json";await X(n,l),e()};return(e,n)=>{const l=A("scale-sync");return J((P(),C("div",{class:"controls",ref_key:"controlsElRef",ref:g},[o("div",q,[o("button",{onClick:_(m,["stop"])},"上传图片"),o("button",{onClick:_(S,["stop"]),ref_key:"startElRef",ref:i},"开始",512),o("button",{onClick:_(E,["stop"]),ref_key:"stopElRef",ref:c,disabled:""},"完毕",512),o("button",{type:"number",onClick:_(y,["stop"])},"画出全部图形"),o("button",{onClick:_(s,["stop"])},"导出数据"),o("button",{onClick:d},"清空画板"),o("input",{type:"number",ref_key:"inputElRef",ref:r},null,512)]),o("div",G,[o("div",null,[D(" 标记点的颜色 "),o("input",{type:"color",onChange:b},null,32)]),H])])),[[l]])}}},Q=R(K,[["__scopeId","data-v-706a354f"]]),Z={class:"catch-patch"},tt={class:"img-wrap"},et=["src"],st={__name:"CatchPatch",props:{},setup(a){const g=h(null),i=h(null),c=h({img_url:""}),r={"update-img-url":s=>{const e=t.img_el;e.onload=n=>{const{width:l,height:p}=e.getBoundingClientRect();u(l,p)},c.value.img_url=s.img_url},"stop-mark-point":s=>{const e=s.shape;b(e)},"draw-all-shapes":s=>{s.shapes.forEach(n=>{b(n)})}};T(r);const m=()=>{const s=g.value,e=s.getContext("2d");e.font=`${t.fontSize}px Arial`,t.canvas_el=s,t.ctx=e,s.width=s.height=0},d=()=>{const s=i.value;t.img_el=s};function u(s,e){t.design.dw=s,t.design.dh=e,t.canvas_el.width=s,t.canvas_el.height=e,t.ctx.clearRect(0,0,s,e)}const S=()=>{x.initShape(),m(),d()},E=s=>{if(t.writing){const e={x:s.offsetX,y:s.offsetY,design:{...t.design},px:(s.offsetX*100/t.design.dw).toFixed(2)+"%",py:(s.offsetY*100/t.design.dh).toFixed(2)+"%"};console.log(e,window.devicePixelRatio),t.currentPoints.push(e),y(e)}else alert("Please start writing first")};function y(s){const e=t.ctx;e.beginPath(),e.arc(s.x,s.y,2,0,2*Math.PI),e.fillStyle=t.markPinterColor,e.fill()}function b(s){const e=t.ctx,{id:n=99,points:l}=s,p=l.length;let v=0,M=0;e.beginPath();for(let w=0;w<p;w++){const f=l[w];if(v+=f.x,M+=f.y,!w){e.moveTo(f.x,f.y);continue}e.lineTo(f.x,f.y)}e.closePath(),e.fillStyle="red",e.fill();const N=v/p,O=M/p;e.fillStyle="white",e.fillText(n,N,O)}return F(()=>{S()}),L(()=>{j(r)}),(s,e)=>(P(),C("div",Z,[k(Q),o("canvas",{ref_key:"canvasElRef",ref:g,onClick:_(E,["stop"])},null,512),o("div",tt,[o("img",{src:c.value.img_url,alt:"",ref_key:"imgElRef",ref:i},null,8,et)])]))}},at=R(st,[["__scopeId","data-v-d72c3f2a"]]),it={__name:"index",setup(a){return(g,i)=>(P(),C("div",null,[k(Y),k(at)]))}};export{it as default};
